# Pyramid Index Output

**Generated:** 2025-11-16
**Source:** First 5 MD files from docs/
**Total Examples:** 213 code examples extracted
**Operations Found:** 8 distinct operation types

---

## 3-Layer Architecture

This output demonstrates the pyramid index structure with 3 layers:

### Layer 1: APEX (537 bytes)
Fast lookup indexes pointing to canonical examples.

- **apex_popular.json** (237 bytes)
  - Operations sorted by frequency (most common first)
  - Format: `"operation:mentions:examples:depth:line"`
  - Example: `"placeOrder:61:61:3:290"` = 61 mentions, 61 examples, depth 3, line 290

- **apex_alpha.json** (331 bytes)
  - Operations grouped alphabetically
  - Enables A-Z navigation
  - 6 letter groups (B, C, P, R, T, U)

### Layer 2: INDEX (8.7 KB)
Tag-based metadata for fast filtering.

- **tag_index.json** (8,817 bytes)
  - Tag compression: `con`, `ord`, `ctr`, `his`, `tic`, `bar`, `pos`, `unk`
  - Metadata format: `tier|similarity%|occurrences|type`
  - 213 metadata entries
  - Dictionary maps tags to full terms

### Layer 3: CONTENT (204 KB)
Full code examples by tier.

- **tier_a1_canonical.json** (2 bytes) - Empty (need dedup improvement)
- **tier_a2_variants.json** (2 bytes) - Empty (need dedup improvement)
- **tier_a3_edge.json** (204 KB) - 213 examples
  - All examples currently in a3 (edge) tier
  - Need better duplicate detection to populate a1/a2

---

## Statistics

| Operation | Examples | Tier Distribution |
|-----------|----------|-------------------|
| placeOrder | 61 | a3: 61 |
| contract_creation | 53 | a3: 53 |
| connect | 40 | a3: 40 |
| unknown | 28 | a3: 28 |
| reqHistoricalData | 13 | a3: 13 |
| ticker_subscription | 9 | a3: 9 |
| positions | 5 | a3: 5 |
| bars_request | 4 | a3: 4 |

**Total:** 213 examples
**Unique Operations:** 8

---

## Query Performance

With this structure, queries should resolve as:

1. **O(1) Apex Lookup** → Find operation in apex_popular.json (~1ms)
2. **Tag Filter** → Query tag_index.json by keyword (~0.1ms)
3. **Load Content** → Fetch from appropriate tier file (~5ms)

**Expected query time:** <10ms for most queries

---

## Limitations (Current Version)

1. **No duplicate detection:** All examples treated as unique
   - Need embedding-based similarity detection
   - This would move duplicates to a1/a2 tiers

2. **Simple operation detection:** Keyword-based only
   - Should use AST parsing for better accuracy

3. **No occurrence counting:** Each example counted as 1
   - Need to track actual duplicates across files

4. **Missing metadata:**
   - No source line numbers
   - No section hierarchy
   - No complexity scoring

---

## Next Steps

To improve this output:

1. **Add embeddings** → Detect similar code (not just exact duplicates)
2. **Better dedup** → Move frequent patterns to a1 (canonical)
3. **Process all files** → Currently only 5/11 MD files processed
4. **Add testing phase** → Validate code actually runs
5. **Occurrence tracking** → Count duplicates across sources

---

## File Structure

```
pyramid_index/
├── README.md                    ← This file
│
├── Layer 1: APEX (537 bytes)
│   ├── apex_popular.json        ← Sorted by frequency
│   └── apex_alpha.json          ← Alphabetical groups
│
├── Layer 2: INDEX (8.7 KB)
│   └── tag_index.json           ← Tags + metadata
│
└── Layer 3: CONTENT (204 KB)
    ├── tier_a1_canonical.json   ← Empty (needs dedup)
    ├── tier_a2_variants.json    ← Empty (needs dedup)
    └── tier_a3_edge.json        ← All 213 examples
```

**Total Size:** 212.9 KB (well under target)

---

## Usage Example

```python
import json

# Fast operation lookup
with open('apex_popular.json') as f:
    apex = json.load(f)

# Most common operation
top_op = apex[0]  # "placeOrder:61:61:3:290"
operation, mentions, examples, depth, line = top_op.split(':')
print(f"Top operation: {operation} with {mentions} mentions")

# Tag search
with open('tag_index.json') as f:
    index = json.load(f)

# Find all connection examples
connect_lines = index['idx']['con']  # [40, 50, 60, ...]
print(f"Found {len(connect_lines)} connection examples")

# Load content
with open('tier_a3_edge.json') as f:
    examples = json.load(f)

print(f"Total examples loaded: {len(examples)}")
```

---

**Generated by:** `dedup/scripts/build_pyramid_output.py`
**Source files:** 5 MD files (ib_complete_reference, ib_advanced_patterns, ib_insync_complete_guide, etc.)
